<!-- TODO sale table style has no margin-bottom, doesn't need to match height with find patient -->
<!-- Use Tab selection from purchase order to select between ID and name search -->
<header>
  <span>Create Patient Invoice</span>
</header>

<section class="underline">
  <div class="pull-right">
    <a class="btn btn-default">
      <span class="glyphicon glyphicon-floppy-save"></span> Import prescription
    </a>
    <a class="btn btn-default">
      <span class="glyphicon glyphicon-th-list"></span> Update Defaults
    </a>
  </div>
</section>

<div class="content">
  
  <div class="row">
    <div class="col-xs-5">
      <div find-patient on-search-complete="initialiseSaleDetails"></div>
    </div>
  </div>

  <div class="row">
    <div class="col-xs-12">
        <div ng-show="invoice.debtor">
          <div class="row">
            <div class="col-xs-6">
              <fieldset>
                <legend>Patient</legend>
                
                <form class="form-horizontal">

                  <div class="form-group">
                    <label for="debtorName" class="control-label col-xs-3">Name</label>
                    <div class="col-xs-9">
                      <input id="debtorName" class="form-invoice" disabled value="{{invoice.debtor.name}}">
                    </div>
                  </div>
                  
                  <div class="form-group">
                    <label for="debtorId" class="control-label col-xs-3">Debtor Id</label>
                    <div class="col-xs-9">
                      <input id="debtorId" class="form-invoice" disabled value="{{invoice.debtor.debitor_id}}">
                    </div>
                  </div>

                </form>

              </fieldset>
            </div>
            <div class="col-xs-6">
              <fieldset>
                <legend>Sale
                  <div class="pull-right">
                    <a class="fieldset-util"><span class="glyphicon glyphicon-pencil"></span> Edit Sale</a>
                  </div>
                </legend>
                
                <form class="form-horizontal">

                  <div class="form-group">
                    <label for="saleId" class="control-label col-xs-2">Id</label>
                    <div class="col-xs-10">
                      <input id="saleId" class="form-invoice" disabled value="{{invoice.id}}">
                    </div>
                  </div>

                  <div class="form-group">
                    <label for="saleDate" class="control-label col-xs-2">Date</label>
                    <div class="col-xs-10">
                      <input class="form-invoice" disabled value="{{invoice.date}}">
                    </div>
                  </div>

                  <div class="form-group">
                    <label for="saleNote" class="control-label col-xs-2">Note</label>
                    <div class="col-xs-10">
                      <input class="form-invoice" disabled value="{{invoice.note}}">
                    </div>
                  </div>

                </form>
              </fieldset>
            </div>
          </div>
         <div class="row">

            <div class="col-xs-12">
              <fieldset>
                <legend>Sale Items
                  <div class="pull-right">
                    <a ng-click="addInvoiceItem()" class="fieldset-util"><span class="glyphicon glyphicon-plus"></span> Add Item Line</a>
                  </div>
                </legend>
                <table class=' table-condensed table'>
                  <thead>
                    <tr>
                      <th>Item</th>
                      <th>Description</th>
                      <th>Qty</th>
                      <th>Unit Price</th>
                      <th>Amount</th>
                      <th></th>
                    </tr>
                  </thead>
                  
                  <tbody>
                    <!-- FIXME: strange filter -->
                    <tr ng-repeat="invoiceItem in invoice.items">
                      <td>
                        <input 
                        class="form-invoice"
                        type="text"
                        typeahead-template-url="invoiceListItem.html"
                        ng-model="invoiceItem.inventoryReference"
                        typeahead="inventoryItem as inventoryItem.code for inventoryItem in inventory | filter:$viewValue | limitTo:8"
                        typeahead-on-select="updateInvoiceItem(invoiceItem, invoiceItem.inventoryReference)"
                        placeholder="Search Inventory Code"
                      </td>
                      
                      <td><input ng-show="invoiceItem.isSet" class="form-invoice" disabled value="{{invoiceItem.text}}"></td>
                      <td><input ng-show="invoiceItem.isSet" class="form-invoice" ng-model="invoiceItem.quantity"></td>
                      <td><input ng-show="invoiceItem.isSet" class="form-invoice" ng-model="invoiceItem.price"></td>
                      <td><input ng-show="invoiceItem.isSet" class="form-invoice" disabled value="{{invoiceItem.quantity * invoiceItem.price | currency}}"></td>
                      <td><a ng-click="removeInvoiceItem($index)"><span class="glyphicon glyphicon-trash"></span></a></td>
                    </tr>
                    
                    <tr>
                      <!-- Style hack -->
                      <td colspan="4" style="margin-right = 50px; text-align: right;"><b>Total</b></td>
                      <td colspan="2"><b>{{invoiceTotal() | currency}}</b></td>
                    </tr>
                    
                  </tbody>
                </table>
              </div>
            </div>
      </div>
    <!-- </div> -->
  </div>

<section class="bar-bottom">
  <div class="pull-right">
    <a ng-disabled="inventory.length==0" ng-click="generateInvoice()" class="btn btn-default"><span class="glyphicon glyphicon-floppy-open"></span> Submit Patient Invoice</a>
  </div>
</section>

<script type="text/ng-template" id="debtorListItem.html">
  <a>
    <span><b>[{{match.model.debitor_id}}]</b></span>
    <span bind-html-unsafe="match.label | typeaheadHighlight:query"></span>
  </a>
</script>

<script type="text/ng-template" id="invoiceListItem.html">
  <a>
    <span bind-html-unsafe="match.label | typeaheadHighlight:query"></span>
    <span><i>{{match.model.text}}</i></span>
  </a>
</script>
