angular.module('bhima.controllers')
.controller('report.service_exploitation', [
  '$scope',
  '$filter',
  '$translate',
  '$q',
  'validate',
  'connect',
  'appstate',
  function ($scope, $filter, $translate, $q, validate, connect, appstate) {
    var session = $scope.session = { count : {} };
    var dependencies = {};
    $scope.services = [];
    $scope.selected = null;

    dependencies.projects = {
      query : {
        tables : {
          'project' : {
            columns : ['id', 'abbr', 'name']
          }
        }
      }
    };

    dependencies.services = {
      query :'/services/'
    };

    function day () {
      session.dateFrom = new Date();
      session.dateTo = new Date();
      reset(session.services);
    }

    function week () {
      session.dateFrom = new Date();
      session.dateTo = new Date();
      session.dateFrom.setDate(session.dateTo.getDate() - session.dateTo.getDay());
      reset(session.services);
    }

    function month () {
      session.dateFrom = new Date();
      session.dateTo = new Date();
      session.dateFrom.setDate(1);
      reset(session.services);
    }

    $scope.options = [
      {
        label : 'CASH_PAYMENTS.DAY',
        fn : day,
      },
      {
        label : 'CASH_PAYMENTS.WEEK',
        fn : week,
      },
      {
        label : 'CASH_PAYMENTS.MONTH',
        fn : month
      }
    ];

    appstate.register('project', function (project) {
      $scope.project = project;

      validate.process(dependencies)
      .then(function (models) {
        $scope.projects = models.projects;
        session.services = models.services;

        var allProjectIds = models.projects.data.reduce(function (a,b) { return a + ',' + b.id ; }, '').substr(1);
        $scope.projects.post({
          id : allProjectIds,
          name : $translate.instant('CASH_PAYMENTS.ALL_PROJECTS')
        });

        session.project = project.id;
        search($scope.options[0]);
      });
    });

    function search (selection) {
      session.selected = selection;
      selection.fn();
    }

    function reset (services) {
      session.searching = true;

      // toggle off active
      session.active = !services;

      req = {
        dateFrom : $filter('date')(session.dateFrom, 'yyyy-MM-dd'),
        dateTo : $filter('date')(session.dateTo, 'yyyy-MM-dd')
      };

      var exploitation = {};
      getCostAndProfit(services);

      // Get Cost and Profit
      function getCostAndProfit (services) {
        session.charge = 0;
        session.profit = 0;

        services.data.forEach(function (service) {
          exploitation = { id : service.id, name : service.service };
          getCost(service.cost_center_id)
          .then(handleResultCost)
          .then(getProfit)
          .then(handleResultProfit);
        });
      }

      function getCost(ccId) {
        return connect.req('/cost_periodic/' + $scope.project.id + '/' + ccId + '/' + req.dateFrom + '/' + req.dateTo);
      }

      function getProfit(pcId) {
        return connect.req('/profit_periodic/' + $scope.project.id + '/' + pcId + '/' + req.dateFrom + '/' + req.dateTo);
      }

      function handleResultCost(value) {
        exploitation.charge = value.data.cost;
        session.charge += exploitation.charge; 
        return $q.when();
      }

      function handleResultProfit(value) {
        exploitation.profit = value.data.profit;
        session.profit += exploitation.profit;
        session.searching = false;
        $scope.services.push(exploitation);
        console.log($scope.services);
      }

    }

    $scope.search = search;
    $scope.reset = reset;
  }
]);
