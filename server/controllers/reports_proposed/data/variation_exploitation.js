// reports_proposed/data/bilan.js
// Collects and aggregates data for the enterprise bilan

var q       = require('q');
var db      = require('../../../lib/db');
var numeral = require('numeral');

var formatDollar = '$0,0.00';
var variationExploitationDate = new Date();
var accountList = [], subAccounts = [], finalList = [], previousExploitations = [], currentExploitations = [], previousSubAccounts = [];

// expose the http route
exports.compile = function (options) {
  'use strict';
  var i18VariationExploitation = options.language == 'fr' ? require('../lang/fr.json').VARIATION_EXPLOITATION : require('../lang/en.json').VARIATION_EXPLOITATION;
  var deferred = q.defer(), context = {}, infos = {}, ROOT_ACCOUNT_ID = 0;

  context.i18n = i18VariationExploitation;
  context.options = options;


  var sql = 
    'SELECT account.id, account.account_number, account.account_txt, account.parent, account.is_charge, account.account_type_id, (CASE WHEN account.is_charge = 1 THEN SUM(period_total.debit - period_total.credit) ELSE SUM(period_total.credit - period_total.debit) END) AS balance ' +
    'FROM account LEFT JOIN period_total on account.id = period_total.account_id WHERE account.is_ohada = 1 AND account.account_type_id in (?,?) AND (period_total.fiscal_year_id in (?) OR ISNULL(period_total.fiscal_year_id)) ' +
    'AND account.id NOT IN (SELECT account.id FROM account WHERE account.account_type_id = ?) GROUP BY account.id';

  db.exec(sql, [1, 3, options.fy, 2])
  .then(function (ce){ 
    currentExploitations = ce;
    return db.exec(sql, [1, 3, options.pfy, 2]);
  })
  .then(function (pe){
    previousExploitations = pe;
    context.data = process().sort(function (a, b){ return a.account_number - b.account_number;});
    deferred.resolve(context);
  })
  .catch(deferred.reject)
  .done();
  return deferred.promise;
};

function process (){
  currentSubAccounts = getSubAccountsOnly(currentExploitations);
  previousSubAccounts = getSubAccountsOnly(previousExploitations);

  currentSubAccounts.forEach(function (item){
    var parent = getParentAccount(item.parent);
    var result = getAllChild(parent.id, true);
    parent.children = result.children;
    parent.percent = result.percent;
    parent.balancePrevious = result.balance_previous;
    parent.viewBalancePrevious = getNumeralFormat(parent.balancePrevious);
    parent.balanceCurrent = result.balance_curent;
    parent.viewBalanceCurrent = getNumeralFormat(parent.balanceCurrent);
    parent.variationValue = getNumeralFormat(parent.balanceCurrent - parent.balancePrevious);
    finalList.push(parent);
  });

  previousSubAccounts.forEach(function (item){
    var parent = getParentAccount(item.parent);
    var result = getAllChild(parent.id, false);
    parent.children = result.children;
    parent.percent = result.percent;
    parent.balancePrevious = result.balance_previous;
    parent.viewBalancePrevious = getNumeralFormat(parent.balancePrevious);
    parent.balanceCurrent = result.balance_curent;
    parent.viewBalanceCurrent = getNumeralFormat(parent.balanceCurrent);
    parent.variationValue = getNumeralFormat(parent.balanceCurrent - parent.balancePrevious);
    finalList.push(parent);
  });

  return finalList;
}

function getParentAccount(parentId){
  var found;
  for (var i = currentExploitations.length - 1; i >= 0; i--) {
    if(currentExploitations[i].id == parentId){
      found = currentExploitations[i];
      break;
    }
  };
  return found;
}

function getSubAccountsOnly (list){
  return list.filter(function (item){
    return item.account_type_id === 1;
  });
}

function getAllChild (parentId){
  var founds = [], cTotalDebit = 0,
      cTotalCredit = 0, cTotalBalance = 0,
      pTotalDebit = 0, pTotalCredit = 0, pTotalBalance = 0, inds_c = [], inds_p = [];

  for (var i = currentSubAccounts.length - 1; i >= 0; i--) {
    if(currentSubAccounts[i].parent === parentId){
      currentSubAccounts[i].balance = (currentSubAccounts[i].balance) ? currentSubAccounts[i].balance : 0;
      currentSubAccounts[i].viewBalance = getNumeralFormat(currentSubAccounts[i].balance);

      currentSubAccounts[i].previousBalance = getPreviousState(currentSubAccounts[i].id).balance;
      currentSubAccounts[i].viewPreviousBalance = getNumeralFormat(currentSubAccounts[i].previousBalance);

      currentSubAccounts[i].percent = getPercent(currentSubAccounts[i].balance - currentSubAccounts[i].previousBalance, currentSubAccounts[i].previousBalance);
      currentSubAccounts[i].variationValue = getNumeralFormat(currentSubAccounts[i].balance - currentSubAccounts[i].previousBalance);

      founds.push(currentSubAccounts[i]);

      cTotalBalance +=currentSubAccounts[i].balance ? currentSubAccounts[i].balance : 0;
      pTotalBalance +=currentSubAccounts[i].previousBalance ? currentSubAccounts[i].previousBalance : 0;
      inds_c.push(i);          
    }
  };

  for (var i = previousSubAccounts.length - 1; i >= 0; i--) {
    if(previousSubAccounts[i].parent === parentId){
      previousSubAccounts[i].previousBalance = (previousSubAccounts[i].balance) ? previousSubAccounts[i].balance : 0;
      previousSubAccounts[i].viewPreviousBalance = getNumeralFormat(previousSubAccounts[i].balance);

      previousSubAccounts[i].balance = 0;
      previousSubAccounts[i].viewBalance = getNumeralFormat(previousSubAccounts[i].balance);

      previousSubAccounts[i].percent = getPercent(previousSubAccounts[i].balance - previousSubAccounts[i].previousBalance, previousSubAccounts[i].previousBalance);
      previousSubAccounts[i].variationValue = getNumeralFormat(previousSubAccounts[i].balance - previousSubAccounts[i].previousBalance);

      founds.push(previousSubAccounts[i]);
      pTotalBalance +=previousSubAccounts[i].previousBalance ? previousSubAccounts[i].previousBalance : 0;
      inds_p.push(i);
    }
  };

  inds_c.forEach(function (item){
    if(item >= 0) {currentSubAccounts.splice(item, 1)};
  });

  inds_p.forEach(function (item){
    if(item >= 0) {previousSubAccounts.splice(item, 1)};
  });  

  return {
    children : founds,
    balance_curent : cTotalBalance,
    balance_previous : pTotalBalance,
    percent : getPercent(cTotalBalance - pTotalBalance, pTotalBalance)
  };
}

function getPreviousState (id){
  var previous = {}, ind = -1;

  for (var i = previousSubAccounts.length - 1; i >= 0; i--) {
    if(previousSubAccounts[i].id == id){
      previous.balance = previousSubAccounts[i].balance ? previousSubAccounts[i].balance : 0;
      ind = i;
      break;
    }
  };
  if(ind >= 0){previousSubAccounts.splice(ind, 1);}else{previous.balance = 0;}
  return previous;
}

function getNumeralFormat (nb){
  return numeral(nb ? nb : 0).format(formatDollar);
}

//calculate the percent of x in y

function getPercent(x, y){
  if(x===0) return 0;
  if(y===0) return 100;

  return (x/y) * 100;
}